# NkSERVICE External API

## Core Commands

The currently supported External API commands as described here. See [External API](api_intro.md) for an introduction to the External API. See the documentation of each plugin to learn the supported classes and commands.

Cmd|Description
---|---
[`list_users`](#list-users)|List current logged in users
[`get_user`](#get-user-info)|Get info about an user
[`logout_session`](#disconnect-a-session)|Forces disconnection of a sessions
[`subscribe`](#subscribe)|Subscribe to events
[`unsubscribe`](#unsubscribe)|Remove a previously registered subscription
[`get_subscriptions`](#get-subscriptions)|Get all current subscriptions
[`send_event`](#send-event)|Fires an event
[`send_user_event`](#send-an-event-to-an-user)|Sends a event to an user
[`send_session_event`](#send-an-event-to-a-session)|Sends a event to a session
[`call_session`](#send-a-command-to-a-session)|Sends a command to a session


### List Users

Returns a list of currently logged in users for the _service_, along with their started
sessions.

**Sample**

```js
{
	class: "core",
	cmd: "list_users",
	tid: 1
}
```
-->
```js
{
	result: "ok",
	data: {
		"user1@domain.com": [
			"54c1b637-36fb-70c2-8080-28f07603cda8",
      		"ed26cbdb-36fb-70d7-fdcd-28f07603cda8"
    	],
		"user2@domain.com": [
      		"b840f878-36fb-70e1-f3df-28f07603cda8"
    	],    	
	}
	tid: 1
}
```


### Get User Info

Gets information about a logged in user. Returns a list of started sessions and metadata stored at the server. The server login can decide which information must be returned.

The field `user` is mandatory.

**Sample**


```js
{
	class: "core",
	cmd: "get_user",
	data: {
		"user": "user1@domain.com"
	},
	tid: 1
}
```
-->
```js
{
	result: "ok",
	data: {
		"54c1b637-36fb-70c2-8080-28f07603cda8": {
			"remote": "wss:127.0.0.1:63393",
			"type": "api_server"
		},
		"ed26cbdb-36fb-70d7-fdcd-28f07603cda8": {
			"remote": "wss:127.0.0.1:63396",
			"type": "api_server"
    	},
	}
	tid: 1
}
```


### Disconnect a session

Disconnects a currently started session. The field `session_id` is mandatory.

**Sample**

```js
{
	class: "core",
	cmd: "logout_session",
	data: {
		"session_id": "54c1b637-36fb-70c2-8080-28f07603cda8"
	},
	tid: 1
}
```


### Subscribe

Allows the connection to subscribe to specific events or event classes. The only mandatory field is `class`. 

See each plugin documentation to learn the supported event subclasses and types of each supported class.

Field|Default|Description
---|---|---|---
class|(mandatory)|Class to subscribe to
subclass|`"*"`|Subscribe only to this subclass (`"*"` to subscribe to all)
type|`"*"`|Only to this event type (`"*"` to subscribe to all)
obj_id|`"*"`|Only to events generated by this specific object (`"*"` to all)
body|`{}`|Body to merge to incoming message's body
service|(this service)|Subscribe to events generated at a different _service_

The subscription attempt must be authorized by the server side code. If the connection is dropped, all subscriptions are deleted.

Fired events can have a body. If both the event's body and the subscription body are objects, they will be merged in the incoming event.

**Sample**

```js
{
	class: "core",
	cmd: "subscribe",
	data: {
		class: "media",
		subclass: "session"
		body: {
			my_key: "my value"
		}
	}
	tid: 1
}
```

This example would subscribe the connection to all specific sessions and event types for sessions belonging to the `media` class. All events sent from class `media`, generated at object `session` (with any `type` and `obj_id`) will be sent to this connection.

Fields omitted or with value `"*"` will match all possible values for that field, including the case were the sender didn't use that field.


### Unsubscribe

Removes a previously registered subscription. Must match exactly the same fields used for the subscription (except `body`).


**Sample**

```js
{
	class: "core",
	cmd: "unsubscribe",
	data: {
		class: "media",
		subclass: "session"
	},
	tid: 1
}
```


### Get subscriptions

Gets the current list of subscriptions for a session.
All sessions are subscribed automatically to receive user events and session events.

**Sample**

```js
{
	class: "core",
	cmd: "get_subscriptions",
	tid: 1
}
```
-->
```js
{
	result: "ok",
	data: [
		{
			"class": "core",
       		"subclass": "session_event",
       		"obj_id": "275a94a7-36fb-8fce-1f4b-28f07603cda8",
       		"type": "*"
        },
     	{
     		"class": "core",
       		"subclass": "user_event",
       		"obj_id": "user1@domain.com",
       		"type": "*"
       	}
    ],
	tid: 1
}
```

### Send event

Allows to fire an event. 

Field|Default|Description
---|---|---|---
class|(mandatory)|Class to send the event to
subclass|`"*"`|Subclass to send the event to
type|`"*"`|Event type to send
obj_id|`"*"`|Specific object id
body|`{}`|Body to include in the message
service|(this service)|Send the event to a different _service_

Fields omitted or with value `"*"` will be omitted in the event. Only clients subscribed to the value `"*"` for that field (or that omitted them in the subscription request) will receive the message.


**Sample**

```js
{
	class: "core",
	cmd: "send_event",
	data: {
		class: "my_class",
		subclass: "my_subclass"
		body: {
			my_key: "my value"
		}
	}
	tid: 1
}
```


### Send an event to an user

Allows a connection to send an event to all started sessions by an specific user.

Field|Default|Description
---|---|---|---
user|(mandatory)|User to send the event to
type|`"*"`|Event type to send
body|`{}`|Body to include in the message


**Sample**

```js
{
	class: "core",
	cmd: "send_user_event",
	data: {
		user: "user2@domain.com",
		type: "my_type",
		body: {
			key: "val"
		}
	},
	tid: 1
}
```

The destination client will receive this message over all started sessions:

```js
{
	class: "core",
	cmd: "event",
	data: {
		class: "core",
		subclass: "user_event",
		type: "my_type",
		obj_id: "user2@domain.com"
	}
	tid: 1
}
```


### Send an event to a session

Allows a connection to send an event to a specific session

Field|Default|Description
---|---|---|---
session_id|(mandatory)|Session to send the event to
type|`"*"`|Event type to send
body|`{}`|Body to include in the message


**Sample**

```js
{
	class: "core",
	cmd: "send_user_event",
	data: {
		session_id: "275a94a7-36fb-8fce-1f4b-28f07603cda8",
	},
	tid: 1
}
```

The destination session will receive this message over all started sessions:

```js
{
	class: "core",
	cmd: "event",
	data: {
		class: "core",
		subclass: "session_event",
		obj_id: "275a94a7-36fb-8fce-1f4b-28f07603cda8"
	}
	tid: 1
}
```



### Send a command to a session

Allows to send a synchronous command a to a different session, and return the response.

Field|Default|Description
---|---|---|---
session_id|(mandatory)|Session to send the event to
class|(mandatory)|Class to include in the request
cmd|(mandatory)|Command to include in the request
dara|`{}`|Optional data field


**Sample**

```js
{
	class: "core",
	cmd: "call_session",
	data: {
		session_id: "275a94a7-36fb-8fce-1f4b-28f07603cda8",
		class: "my_class",
		cmd: "my_cmd",
		data: { 
			key: "val"
		}
	},
	tid: 1
}
```

The destination session will receive this request:

```js
{
	class: "my_class",
	cmd: "my_cmd",
	data: {
		key: "val",
	}
	tid: 1001
}
```

then, if the remote sessions answers:

```js
{
	result: "ok",
	data: {
		received: true,
	}
	tid: 1001
}
```

the calling session will receive as response:

```js
{
	result: "ok",
	data: {
		received: true,
	}
	tid: 1
}
```



